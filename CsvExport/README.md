# CSVをエクスポートする時に色々したこと。

業務用のアプリケーション作ってるときに大概あるのがCSV出力ですが

WEBでCSV出力するときに、ちょいとはまったのでメモがてらに記事投稿します。

# エクスポートしたCSVどうやってWEBで受け取るの？

すごく単純な方法だとHTTPのリクエストを飛ばすだけです。

``` typescript
window.location.href = "CSVを出力するAPIのURL";
```

CSVのレスポンスがあれば勝手にDLが始まります。

CSVのエクスポートはChromeとかだと問題ないのですが

IEとかEdgeとかだと、utf-8のFormatでDLしようとしやがるので文字化けします。

こんな感じで…


あと、上記の方法だとビジネスロジックのエラー発生時にハンドリングしづらいです。

# 対策

受け取ったCSVデータからBLOBオブジェクトを生成

そいつに名前をつけてやる形で日本語名称の文字化けを解消します。

TypeScriptのAPIの受け口は下記のように作ります。

参考
https://github.com/angular/angular/issues/14083


readyStateが完了したとき（＝４）、どのような状態で返却されたかによってresponseTypeを決定します。

(BLOBのままだとresponseTextでエラー吐いて使えないですからね)

WebAPI側では、ビジネスロジックエラーが発生した場合、InternalServerErrorのステータスで返却しています。

BLOB化したあとはCSVファイルとしてDLさせます。IE系列とそれ以外とでロジックがちがうので

下記のような感じなります。


# 結果

こんな感じで動作します。

# 最後に

今回作成したソースは下記リポジトリで管理しています。